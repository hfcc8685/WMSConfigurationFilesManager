<!DOCTYPE html>
<html>
  <head>
    <title>WMSCFM</title>
		<meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">
		<link rel="stylesheet" type="text/css" href="css/bootstrap-dialog.min.css">
		<link rel="stylesheet" type="text/css" href="codemirror/lib/codemirror.css">
		<link rel="stylesheet" type="text/css" href="css/titlebar.css">
		<link rel="stylesheet" type="text/css" href="css/main.css">
  </head>
  <body>
		<!--titleBar Start-->
		<div id="top-titlebar" class="top-titlebar">
			<div class="top-titlebar-icon">
				<img id="top-titlebaricon" src="resources/top-titlebar.png"/>
			</div>
			<div class="top-titlebar-text">WMSCFM</div>
			<div id="top-titlebar-settings-button" class="top-titlebar-settings-button iconButton" aria-hidden="true"
				data-toggle="tooltip" data-placement="left" title data-original-title="设置">
				<span class="glyphicon glyphicon-cog"></span>
			</div>
			<div id="top-titlebar-close-button" class="top-titlebar-close-button iconButton" aria-hidden="true">
				<span class="glyphicon glyphicon-remove"></span>
			</div>
			<div class="top-titlebar-divider"></div>
		</div>	
		<!--titleBar end-->
		
		<div class="btn-toolbar" role="toolbar">
			<div class="btn-group">
				<button type="button" class="btn btn-success" id="btn-temp">
					<span class="glyphicon glyphicon-pencil"></span> 修改配置文件为测试环境
				</button>
				<button type="button" class="btn btn-warning">
					<span class="glyphicon glyphicon-pencil"></span> 修改配置文件为预发布环境
				</button>
				<button type="button" class="btn btn-danger">
					<span class="glyphicon glyphicon-pencil"></span> 修改配置文件为线上环境
				</button>
			</div>
		</div>

		<!--main start-->
	  <div class="content">
			<div class="container-fluid">
				<div class="row">
					<div class="col-lg-4">
						<div class="panel panel-primary">
							<div class="panel-heading">
								<h4 class="panel-title pull-left"><span class="glyphicon glyphicon-th-list"></span> 配置文件</h4>
								<button type="button" class="btn btn-info pull-right" id="button-scanfile" data-loading-text="扫描中...">
									<span class="glyphicon glyphicon-search"></span> 开始扫描配置文件
								</button>
							  <div class="clearfix"></div>
 							</div>
  						<div class="panel-body" id="panel-file-list">
								<div class="list-group" id="div-file-list">
								</div>
							</div>
						</div>
					</div>
					<div class="col-lg-8">
						<div class="panel panel-success">
							<div class="panel-heading">
								<h4 class="panel-title pull-left"><span class="glyphicon glyphicon-edit"></span> 配置文件编辑器</h4>
								<button type="button" class="btn btn-success pull-right">
									<span class="glyphicon glyphicon-floppy-saved"></span> 保存
								</button>
								<div class="clearfix"></div>
 							</div>
  						<div class="panel-body" id="panel-file-show">
								<textarea id="code"></textarea> 		
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<!--main end-->

		<!--settings start-->
		<div class="modal fade bs-example-modal-lg" id="settings" tabindex="-1" role="dialog" aria-lableledby="settingslabel" aria-hidden="true">
			<div class="modal-dialog modal-lg">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        		<h4 class="modal-title" id="settingslabel">软件设置</h4>
					</div>
					<div class="modal-body">

						<div class="panel panel-success">
							<div class="panel-heading"><h3 class="panel-title">项目路径(换行分割)</h3></div>									
							<div class="panel-body">
							  <textarea class="form-control" rows="5" id="textarea-config-projectAddress"></textarea>	
							</div>
						</div>

						<div class="panel panel-info">
							<div class="panel-heading"><h3 class="panel-title">文件过滤(换行分割)</h3></div>
							<div class="panel-body">
								<textarea class="form-control" rows="5" id="textarea-config-file"></textarea>
							</div>
						</div>

						<div class="panel panel-primary">
							<div class="panel-heading"><h3 class="panel-title">字符替换</h3></div>
							<div class="panel-body">test</div>
						</div>

					</div>

					<div class="modal-footer">
        		<button type="button" class="btn btn-primary" id="button-config-save">保存</button>
						<button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
					<div>
				</div>
			</div>
		</div>
		<!--settings end-->

    <script src="js/jquery.js"></script>
    <script src="js/bootstrap.min.js"></script>
		<script src="js/bootstrap-dialog.min.js"></script>
		<script src="codemirror/lib/codemirror.js"></script>
		<script src="codemirror/mode/xml/xml.js"></script>
		<script src="codemirror/addon/selection/active-line.js"></script>
		<script src="js/main.js"></script>
		<script type="text/javascript">
			var fs = require('fs');
			var path = require('path');

			var editor = CodeMirror.fromTextArea(document.getElementById("code"), {
  			mode: "application/xml",
  			styleActiveLine: true,
  			lineNumbers: true,
  			lineWrapping: true
			});

			function focusTitlebars(focus) {
  			var bg_color = focus ? "#3a3d3d" : "#7a7c7c";    
  			$("#top-titlebar").css("background-color",bg_color);
			}

			$(function(){

				$(window).focus(function() {
       		focusTitlebars(true);
    		});

    		$(window).blur(function() {
					focusTitlebars(false);
    		});

				$('#top-titlebar-close-button').click(function(){
					window.close();
				});			

				$('#top-titlebar-settings-button').tooltip();
				$('#top-titlebar-settings-button').click(function(){
					$('#settings').modal();	
					fs.readFile('config.json',function (err, data) {
						if (err) {
							showError(err.toString());
							return;
						}						
						var config = JSON.parse(data);						
						$('#textarea-config-projectAddress').val(config.scanProjectAddress.join("\n"));
						$('#textarea-config-file').val(config.scanFileFilter.join("\n"));
					});
				});

				$('#button-config-save').click(function() {
				  var scanProjectAddress = $('#textarea-config-projectAddress').val().split("\n");
					var scanFileFilter = $('#textarea-config-file').val().split("\n");
					var config = {
						"scanProjectAddress" : scanProjectAddress,
						"scanFileFilter" : scanFileFilter
					};
					fs.writeFile('config.json',JSON.stringify(config),function (err){
						if (err)
							showError(err.toString());
						else
					 		showSuccess("保存成功");
					});
				});

				$('#button-scanfile').click(function() {
					var btn = $(this);					
					btn.button('loading');
					$("#div-file-list").empty()				
					fs.readFile('config.json',function(err,data){
						if (err) showError(err.toString());
						var configFile = JSON.parse(data);
						var scanProjectAddress = configFile.scanProjectAddress;
						var scanFileFilter = configFile.scanFileFilter;
						$.each(scanProjectAddress,function() {
							scanFile(this.toString(),scanFileFilter);
						});
						btn.button('reset');
					});
				});

				$('#btn-temp').click(function() {
				});

			});
		</script>
  </body>
</html>
