<!DOCTYPE html>
<html>
  <head>
    <title>WMSCFM</title>
		<meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">
		<link rel="stylesheet" type="text/css" href="css/bootstrap-dialog.min.css">
		<link rel="stylesheet" type="text/css" href="codemirror/lib/codemirror.css">
		<link rel="stylesheet" type="text/css" href="css/main.css">
  </head>
  <body>
		
		<nav class="navbar navbar-inverse navbar-fixed-top" role="navigation" id="nav-title">
			  <div class="navbar-brand"><span class="glyphicon glyphicon-fire"></span> WMSCFM</div>
				<a href="#" class="btn navbar-btn navbar-right" id="nav-title-close">
					<span class="glyphicon glyphicon-remove"></span>
				</a>
				<a href="#" class="btn navbar-btn navbar-right" id="nav-title-settings">
					<span class="glyphicon glyphicon-cog"></span>
				</a>
		</nav>

		<!--main start-->
	  <div class="content">
			<div class="container-fluid">
			<div class="panel panel-primary pull-left" id="panel-file-list">
				<div class="panel-heading">
					<h4 class="panel-title pull-left"><span class="glyphicon glyphicon-th-list"></span> 配置文件</h4>
					<div class="btn-group pull-right">
						<button type="button" class="btn btn-info" id="button-scanfile" data-loading-text="扫描中...">
							<span class="glyphicon glyphicon-search"></span> 开始扫描配置文件
						</button>
 						<button type="button" class="btn btn-info dropdown-toggle" data-toggle="dropdown">
    					<span class="caret"></span>
    					<span class="sr-only">Toggle Dropdown</span>
  					</button>
						<ul class="dropdown-menu" role="menu">
    					<li><a href="#"><span class="glyphicon glyphicon-pencil"></span> 修改为测试环境</a></li>
							<li class="divider"></li>
    					<li><a href="#"><span class="glyphicon glyphicon-pencil"></span> 修改为预发布环境</a></li>
    					<li class="divider"></li>
							<li><a href="#"><span class="glyphicon glyphicon-pencil"></span> 修改为线上环境</a></li>
  					</ul>
					</div>
					<div class="clearfix"></div>
 				</div>
  			<div class="panel-body">
					<div class="list-group" id="div-file-list"></div>
				</div>
			</div>
			<div class="panel panel-success pull-left" id="panel-file-show">
				<div class="panel-heading">
					<h4 class="panel-title pull-left"><span class="glyphicon glyphicon-edit"></span> 配置文件编辑器</h4>
					<button type="button" class="btn btn-success pull-right" id="btn-save-singleFile">
						<span class="glyphicon glyphicon-floppy-saved"></span> 保存
					</button>
					<div class="clearfix"></div>
 				</div>
  			<div class="panel-body">
					<textarea id="code"></textarea> 		
				</div>
			</div>
			<div class="clearfix"></div>
		</div>
		</div>
		<!--main end-->

		<!--settings start-->
		<div class="modal fade bs-example-modal-lg" id="settings" tabindex="-1" role="dialog" aria-lableledby="settingslabel" aria-hidden="true">
			<div class="modal-dialog modal-lg">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        		<h4 class="modal-title" id="settingslabel">软件设置</h4>
					</div>
					<div class="modal-body">

						<div class="panel panel-success">
							<div class="panel-heading"><h3 class="panel-title">项目路径(换行分割)</h3></div>									
							<div class="panel-body">
							  <textarea class="form-control" rows="5" id="textarea-config-projectAddress"></textarea>	
							</div>
						</div>

						<div class="panel panel-info">
							<div class="panel-heading"><h3 class="panel-title">文件过滤(换行分割)</h3></div>
							<div class="panel-body">
								<textarea class="form-control" rows="5" id="textarea-config-file"></textarea>
							</div>
						</div>

						<div class="panel panel-primary">
							<div class="panel-heading"><h3 class="panel-title">字符替换</h3></div>
							<div class="panel-body">test</div>
						</div>

					</div>

					<div class="modal-footer">
        		<button type="button" class="btn btn-primary" id="button-config-save">保存</button>
						<button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
					<div>
				</div>
			</div>
		</div>
		<!--settings end-->

    <script src="js/jquery.js"></script>
    <script src="js/bootstrap.min.js"></script>
		<script src="js/bootstrap-dialog.min.js"></script>
		<script src="codemirror/lib/codemirror.js"></script>
		<script src="codemirror/mode/xml/xml.js"></script>
		<script src="codemirror/addon/selection/active-line.js"></script>
		<script src="js/main.js"></script>
		<script type="text/javascript">
			var fs = require('fs');
			var path = require('path');
			var gui = require('nw.gui');
			var win = gui.Window.get();
			var currentFilePath;

			var editor = CodeMirror.fromTextArea(document.getElementById("code"), {
  			mode: "application/xml",
  			styleActiveLine: true,
  			lineNumbers: true,
  			lineWrapping: true
			});
			
			$(function(){
				$(window).on('focus', function () {
					$("#nav-title").css("background-color","#222222");
  			});

  			$(window).on('blur', function () {
					$("#nav-title").css("background-color","#7a7c7c");
  			});

				$('#nav-title-close').click(function(){
					win.close();
				});			

				$('#nav-title-settings').click(function(){
					$('#settings').modal();	
					fs.readFile('config.json',function (err, data) {
						if (err) {
							showError(err.toString());
							return;
						}						
						var config = JSON.parse(data);						
						$('#textarea-config-projectAddress').val(config.scanProjectAddress.join("\n"));
						$('#textarea-config-file').val(config.scanFileFilter.join("\n"));
					});
				});

				$('#button-config-save').click(function() {
				  var scanProjectAddress = $('#textarea-config-projectAddress').val().split("\n");
					var scanFileFilter = $('#textarea-config-file').val().split("\n");
					var config = {
						"scanProjectAddress" : scanProjectAddress,
						"scanFileFilter" : scanFileFilter
					};
					fs.writeFile('config.json',JSON.stringify(config),function (err){
						if (err)
							showError(err.toString());
						else
					 		showSuccess("保存成功");
					});
				});

				$('#button-scanfile').click(function() {
					var btn = $(this);					
					btn.button('loading');
					$("#div-file-list").empty()				
					fs.readFile('config.json',function(err,data){
						if (err) showError(err.toString());
						var configFile = JSON.parse(data);
						var scanProjectAddress = configFile.scanProjectAddress;
						var scanFileFilter = configFile.scanFileFilter;
						$.each(scanProjectAddress,function() {
							scanFile(this.toString(),scanFileFilter);
						});
						btn.button('reset');
					});
				});

				$('#btn-save-singleFile').click(function() {
					if (currentFilePath) {
						var editfile = editor.getValue(); 
						fs.writeFile(currentFilePath, editfile,function (err){
						if (err)
							showError(err.toString());
						else
					 		showSuccess("保存成功");
					});
						
					}
				});

			});
		</script>
  </body>
</html>
